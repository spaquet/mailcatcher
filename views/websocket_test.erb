<!DOCTYPE html>
<html>
<head>
    <title>MailCatcher WebSocket Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .status {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 12px 16px;
            background: #f0f0f0;
            border-radius: 4px;
            font-weight: 500;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .status-indicator.connected {
            background: #4CAF50;
        }
        .status-indicator.disconnected {
            background: #f44336;
        }
        .status-indicator.connecting {
            background: #ff9800;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .buttons {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover {
            background: #1976D2;
        }
        button:active {
            transform: scale(0.98);
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            margin-top: 20px;
        }
        .log-entry {
            margin: 8px 0;
            display: flex;
            gap: 12px;
        }
        .log-time {
            color: #999;
            min-width: 90px;
            flex-shrink: 0;
        }
        .log-message {
            flex: 1;
            color: #333;
        }
        .log-message.info { color: #2196F3; }
        .log-message.success { color: #4CAF50; }
        .log-message.error { color: #f44336; }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        .info-item {
            padding: 12px;
            background: #f9f9f9;
            border-left: 3px solid #2196F3;
            border-radius: 2px;
        }
        .info-item label {
            font-weight: 600;
            color: #666;
            display: block;
            margin-bottom: 4px;
        }
        .info-item value {
            font-family: monospace;
            color: #333;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MailCatcher WebSocket Test</h1>

        <div class="status">
            <div class="status-indicator disconnected" id="statusIndicator"></div>
            <span id="statusText">Status: Disconnected</span>
        </div>

        <div class="info-grid">
            <div class="info-item">
                <label>WebSocket URL:</label>
                <value id="wsUrl"></value>
            </div>
            <div class="info-item">
                <label>Ready State:</label>
                <value id="readyState">Not initialized</value>
            </div>
        </div>

        <div class="buttons">
            <button onclick="testWebSocket()">Test WebSocket Connection</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let ws = null;

        function getWebSocketURL() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const basePath = '<%= settings.prefix.chomp("/") %>';
            return `${protocol}//${host}${basePath}/messages`;
        }

        function updateStatus(connected, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            indicator.className = 'status-indicator';
            if (connected === true) {
                indicator.classList.add('connected');
                statusText.textContent = `Status: ✓ Connected`;
            } else if (connected === false) {
                indicator.classList.add('disconnected');
                statusText.textContent = `Status: ✗ ${message || 'Disconnected'}`;
            } else {
                indicator.classList.add('connecting');
                statusText.textContent = `Status: ⟳ Connecting...`;
            }
        }

        function updateReadyState() {
            const readyStateDiv = document.getElementById('readyState');
            if (ws) {
                const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                readyStateDiv.textContent = `${ws.readyState} (${states[ws.readyState]})`;
            }
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const time = new Date();
            const timeStr = time.toLocaleTimeString();

            const timeEl = document.createElement('div');
            timeEl.className = 'log-time';
            timeEl.textContent = `[${timeStr}]`;

            const msgEl = document.createElement('div');
            msgEl.className = `log-message ${type}`;
            msgEl.textContent = message;

            entry.appendChild(timeEl);
            entry.appendChild(msgEl);
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testWebSocket() {
            addLog('Attempting to connect to WebSocket...', 'info');

            const wsUrl = getWebSocketURL();
            document.getElementById('wsUrl').textContent = wsUrl;

            updateStatus(null);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    addLog('✓ WebSocket connection established!', 'success');
                    updateStatus(true);
                    updateReadyState();
                };

                ws.onmessage = function(event) {
                    addLog(`Received: ${event.data.substring(0, 100)}${event.data.length > 100 ? '...' : ''}`, 'info');
                };

                ws.onerror = function(error) {
                    addLog(`✗ WebSocket error: ${error}`, 'error');
                    updateStatus(false, 'Error');
                    updateReadyState();
                };

                ws.onclose = function(event) {
                    addLog(`✗ WebSocket closed: Code ${event.code}, Reason: ${event.reason || 'No reason'}`, 'error');
                    updateStatus(false, `Closed (Code: ${event.code})`);
                    updateReadyState();
                    ws = null;
                };
            } catch (e) {
                addLog(`✗ Exception: ${e.message}`, 'error');
                updateStatus(false, 'Exception');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Page loaded, ready to test WebSocket');
            document.getElementById('wsUrl').textContent = getWebSocketURL();
        });
    </script>
</body>
</html>
