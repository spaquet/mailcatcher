<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      margin: 0;
      padding: 20px 28px;
      font-family: 'Monaco', 'Courier New', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      background: #ffffff;
    }
    .transcript-header {
      background: #f9f9f9;
      border: 1px solid #e8eaed;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 20px;
    }
    .transcript-header h3 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #5f5f5f;
      margin: 0 0 12px 0;
    }
    .transcript-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .transcript-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .transcript-info-label {
      font-size: 10px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .transcript-info-value {
      font-size: 12px;
      color: #1a1a1a;
      font-family: 'Monaco', 'Courier New', monospace;
      word-break: break-all;
    }
    .transcript-search-box {
      margin-bottom: 16px;
      position: relative;
    }
    .transcript-search-box input {
      width: 100%;
      padding: 10px 36px 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto';
      background: #ffffff;
    }
    .transcript-search-box input:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    .transcript-log {
      background: #f9f9f9;
      border: 1px solid #e8eaed;
      border-radius: 6px;
      padding: 16px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
    }
    .transcript-entry {
      display: flex;
      gap: 12px;
      margin: 6px 0;
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .transcript-entry:last-child {
      border-bottom: none;
    }
    .transcript-entry.hidden {
      display: none;
    }
    .transcript-time {
      color: #999;
      min-width: 100px;
      flex-shrink: 0;
      font-size: 11px;
    }
    .transcript-type {
      min-width: 80px;
      flex-shrink: 0;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .transcript-type.connection { color: #9c27b0; }
    .transcript-type.command { color: #2196F3; }
    .transcript-type.response { color: #34a853; }
    .transcript-type.tls { color: #ff9800; }
    .transcript-type.data { color: #607d8b; }
    .transcript-type.error { color: #f44336; }
    .transcript-direction {
      min-width: 60px;
      flex-shrink: 0;
      font-size: 11px;
      color: #666;
    }
    .transcript-direction.client::before {
      content: '→ ';
      color: #2196F3;
    }
    .transcript-direction.server::before {
      content: '← ';
      color: #34a853;
    }
    .transcript-message {
      flex: 1;
      color: #1a1a1a;
      font-size: 12px;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .transcript-message.error {
      color: #f44336;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="transcript-header">
    <h3>SMTP Session Information</h3>
    <div class="transcript-info-grid">
      <div class="transcript-info-item">
        <div class="transcript-info-label">Client</div>
        <div class="transcript-info-value"><%= transcript['client_ip'] %>:<%= transcript['client_port'] %></div>
      </div>
      <div class="transcript-info-item">
        <div class="transcript-info-label">Server</div>
        <div class="transcript-info-value"><%= transcript['server_ip'] %>:<%= transcript['server_port'] %></div>
      </div>
      <div class="transcript-info-item">
        <div class="transcript-info-label">Session ID</div>
        <div class="transcript-info-value"><%= transcript['session_id'] %></div>
      </div>
      <div class="transcript-info-item">
        <div class="transcript-info-label">TLS</div>
        <div class="transcript-info-value">
          <% if transcript['tls_enabled'] %>
            ✓ <%= transcript['tls_protocol'] || 'Enabled' %>
          <% else %>
            ✗ Not used
          <% end %>
        </div>
      </div>
      <% if transcript['tls_enabled'] && transcript['tls_cipher'] %>
        <div class="transcript-info-item">
          <div class="transcript-info-label">Cipher</div>
          <div class="transcript-info-value"><%= transcript['tls_cipher'] %></div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="transcript-search-box" style="width: 50%;">
    <input type="text" id="transcriptSearch" placeholder="Filter transcript entries..." style="width: 100%;" />
    <button class="transcript-search-clear" id="transcriptSearchClear" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; display: none; font-size: 18px; padding: 0; width: 20px; height: 20px;">×</button>
  </div>

  <div class="transcript-log">
    <% if transcript['entries'] && transcript['entries'].length > 0 %>
      <% transcript['entries'].each do |entry| %>
        <div class="transcript-entry" data-searchable="<%= CGI.escapeHTML(entry.to_json.downcase) %>">
          <div class="transcript-time">
            <%
              time = Time.parse(entry['timestamp'])
              hours = time.strftime('%H')
              minutes = time.strftime('%M')
              seconds = time.strftime('%S')
              ms = (time.usec / 1000).to_s.rjust(3, '0')
            %>
            <%= "#{hours}:#{minutes}:#{seconds}.#{ms}" %>
          </div>
          <div class="transcript-type <%= entry['type'] %>"><%= entry['type'] %></div>
          <div class="transcript-direction <%= entry['direction'] %>"><%= entry['direction'] %></div>
          <div class="transcript-message <%= 'error' if entry['type'] == 'error' %>"><%= CGI.escapeHTML(entry['message']) %></div>
        </div>
      <% end %>
    <% else %>
      <div style="text-align: center; padding: 40px 20px; color: #999; font-size: 14px;">
        No transcript entries found.
      </div>
    <% end %>
  </div>

  <script>
    var searchInput = document.getElementById('transcriptSearch');
    var searchClear = document.getElementById('transcriptSearchClear');
    var entries = document.querySelectorAll('.transcript-entry');

    function filterEntries() {
      var query = searchInput.value.toLowerCase().trim();
      entries.forEach(function(entry) {
        if (!query) {
          entry.classList.remove('hidden');
        } else {
          var searchable = entry.getAttribute('data-searchable');
          if (searchable.indexOf(query) >= 0) {
            entry.classList.remove('hidden');
          } else {
            entry.classList.add('hidden');
          }
        }
      });
      searchClear.style.display = query ? 'block' : 'none';
    }

    searchInput.addEventListener('keyup', filterEntries);
    searchClear.addEventListener('click', function() {
      searchInput.value = '';
      filterEntries();
      searchInput.focus();
    });

    // Auto-scroll to bottom
    var log = document.querySelector('.transcript-log');
    if (log) {
      log.scrollTop = log.scrollHeight;
    }
  </script>
</body>
</html>
