<!DOCTYPE html>
<html class="mailcatcher">
  <head>
    <title>MailCatcher</title>
    <base href="<%= settings.prefix.chomp("/") %>/">
    <link href="favicon.ico" rel="icon">
    <script src="<%= asset_path("mailcatcher.js") %>"></script>
    <!-- Tippy.js v6 for email signature tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css">
    <!-- Highlight.js for syntax highlighting HTML emails -->
    <script src="https://unpkg.com/highlight.js@11/highlight.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/highlight.js@11/styles/atom-one-light.min.css">
    <style>
      /* MailCatcher UI Styles - Complete inline stylesheet
         This is the single source of truth for all MailCatcher UI styling.
         No external CSS files are loaded (old Sass assets are deprecated).
         All changes should be made here for modern, responsive design.
      */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        background: #ffffff;
        color: #1a1a1a;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
        border-bottom: 1px solid #e8eaed;
        padding: 20px 28px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        display: flex;
        gap: 20px;
        align-items: flex-start;
      }

      header > div:first-child {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      header h1 {
        font-size: 22px;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.5px;
      }

      header h1 a {
        color: #2196F3;
        text-decoration: none;
        transition: color 0.2s;
      }

      header h1 a:hover {
        color: #1976D2;
      }

      .version-badge {
        font-size: 11px;
        color: #999;
        font-weight: 400;
        letter-spacing: 0.5px;
      }

      .header-controls {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
        flex: 1;
      }

      .search-box {
        flex: 0 1 440px;
        position: relative;
        display: flex;
        align-items: center;
      }

      .search-box input {
        width: 100%;
        padding: 9px 32px 9px 36px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: #ffffff;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .search-box input:focus {
        outline: none;
        border-color: #2196F3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        color: #999;
        pointer-events: none;
      }

      .search-clear {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        color: #999;
        cursor: pointer;
        display: none;
        background: none;
        border: none;
        padding: 0;
        transition: color 0.2s;
      }

      .search-clear:hover {
        color: #666;
      }

      .search-box input:not(:placeholder-shown) ~ .search-clear {
        display: block;
      }

      /* Hide browser's native search clear button */
      .search-box input::-webkit-search-cancel-button {
        display: none;
      }

      .attachment-filter {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .attachment-filter select {
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #ffffff;
        color: #1a1a1a;
        cursor: pointer;
        font-size: 13px;
        transition: border-color 0.2s;
      }

      .attachment-filter select:hover {
        border-color: #2196F3;
      }

      .attachment-filter select:focus {
        outline: none;
        border-color: #2196F3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      .header-info {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .status-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        background: #f0f0f0;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
      }

      .status-badge .indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #34a853;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      .status-badge.disconnected .indicator {
        background: #ea4335;
        animation: none;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background: #2196F3;
        color: #ffffff;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn:hover {
        background: #1976D2;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn svg {
        width: 16px;
        height: 16px;
      }

      .email-count {
        font-size: 13px;
        color: #5f5f5f;
        padding: 8px 12px;
        background: #f9f9f9;
        border-radius: 6px;
      }

      main {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
        position: relative;
      }

      #messages {
        flex: 0 0 300px;
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border-bottom: 1px solid #e8eaed;
        overflow: hidden;
        min-height: 150px;
      }

      #resizer {
        width: 100%;
        height: 8px;
        background: #e8eaed;
        cursor: row-resize;
        flex-shrink: 0;
        transition: background 0.2s;
        position: relative;
        z-index: 5;
        user-select: none;
      }

      #resizer:hover {
        background: #2196F3;
      }

      #resizer .ruler {
        display: none;
      }

      #messages table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      #messages thead {
        background: #f9f9f9;
        border-bottom: 1px solid #e8eaed;
        position: sticky;
        top: 0;
        z-index: 10;
        flex-shrink: 0;
        display: flex;
        width: 100%;
      }

      #messages thead tr {
        display: flex;
        width: 100%;
      }

      #messages th {
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #5f5f5f;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
        flex: 1;
      }

      #messages th.col-attachments {
        flex: 0 0 40px;
        padding: 12px 8px;
        text-align: center;
      }

      #messages th.col-bimi {
        flex: 0 0 40px;
        padding: 12px 8px;
        text-align: center;
      }

      #messages tbody {
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      #messages tbody tr {
        display: flex;
        width: 100%;
        flex-shrink: 0;
      }

      #messages tr {
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.15s;
      }

      #messages tr:hover {
        background-color: #f9f9f9;
      }

      #messages tr.selected {
        background-color: #f0f4ff;
      }

      #messages tr.selected:hover {
        background-color: #e6ecff;
      }

      #messages td {
        padding: 12px 16px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        min-width: 0;
        text-align: left;
        flex: 1;
      }

      #messages td.blank {
        color: #999;
        font-style: italic;
      }

      #messages td.col-attachments {
        flex: 0 0 40px;
        padding: 12px 8px;
        text-align: center;
        font-size: 16px;
        overflow: visible;
        white-space: normal;
      }

      #messages td.col-bimi {
        flex: 0 0 40px;
        padding: 12px 8px;
        text-align: center;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        overflow: visible;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #messages .bimi-placeholder-icon {
        width: 24px;
        height: 24px;
        color: #ccc;
        flex-shrink: 0;
      }

      #messages .bimi-image {
        max-width: 32px;
        max-height: 32px;
        flex-shrink: 0;
      }

      #messages td.subject-cell {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 2px;
        padding: 10px 16px;
        overflow: hidden;
      }

      #messages .subject-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: normal;
      }

      #messages .subject-text strong {
        font-weight: 600;
        color: #1a1a1a;
      }

      #messages .preview-text {
        font-size: 12px;
        color: #999;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: normal;
      }

      #messages td.from-cell {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 2px;
        padding: 10px 16px;
        overflow: hidden;
      }

      #messages .sender-text-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
        overflow: hidden;
      }

      #messages .sender-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: normal;
      }

      #messages .sender-name strong {
        font-weight: 600;
        color: #1a1a1a;
      }

      #messages .sender-email {
        font-size: 12px;
        color: #999;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: normal;
      }

      #messages td.to-cell {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 2px;
        padding: 10px 16px;
        overflow: hidden;
      }

      #messages td.to-cell strong {
        font-weight: 600;
        color: #1a1a1a;
      }

      #messages .from-content {
        display: flex;
        align-items: center;
        gap: 6px;
        overflow: hidden;
      }

      #messages .attachment-icon {
        flex-shrink: 0;
        font-size: 14px;
        margin-right: -2px;
      }

      #messages .bimi-icon {
        flex-shrink: 0;
        font-size: 16px;
        width: 20px;
        height: 20px;
        border-radius: 3px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        margin-right: 4px;
      }

      #messages .sender-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #message {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #ffffff;
        overflow: hidden;
      }

      #message > header {
        border-bottom: 1px solid #e8eaed;
        padding: 12px 28px;
        background: #f9f9f9;
        overflow-y: auto;
        max-height: 40%;
        flex-shrink: 0;
      }

      .metadata {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 0;
      }

      .metadata-column {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .metadata-item {
        display: grid;
        grid-template-columns: 90px 1fr;
        gap: 20px;
      }

      .metadata dt {
        font-weight: 600;
        color: #5f5f5f;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
      }

      .metadata dd {
        color: #1a1a1a;
        font-size: 11px;
        word-break: break-word;
        line-height: 1.2;
      }

      .attachments-column {
        display: none;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
      }

      .attachments-column.visible {
        display: flex;
      }

      .attachments-header {
        font-weight: 600;
        color: #5f5f5f;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
        flex-shrink: 0;
      }

      .attachments-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 8px;
        min-width: 0;
      }

      .attachments-list li {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 6px 8px;
        background: #f9f9f9;
        border-radius: 4px;
        font-size: 11px;
      }

      .attachments-list a {
        color: #2196F3;
        text-decoration: none;
        flex: 1;
        min-width: 0;
        word-break: break-word;
      }

      .attachments-list a:hover {
        text-decoration: underline;
      }

      .attachment-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .attachment-size {
        color: #666;
        font-size: 10px;
      }

      .attachment-type {
        color: #999;
        font-size: 9px;
      }

      #message > header {
        display: grid;
        grid-template-columns: auto minmax(300px, 0.6fr) 280px;
        gap: 20px;
        align-items: start;
      }

      .views-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        order: -1;
        align-items: flex-start;
      }

      .views {
        display: flex;
        gap: 16px;
        flex-direction: row;
        align-items: center;
        width: 100%;
      }

      .views ul {
        list-style: none;
        display: flex;
        gap: 8px;
        flex-direction: row;
        margin: 0;
      }

      .views .views-tabs {
        flex: 0 0 auto;
      }

      .views .views-actions {
        flex: 1 0 auto;
        justify-content: flex-end;
        gap: 10px;
      }

      .views .views-actions li {
        display: flex;
        align-items: center;
      }

      .views-container .download-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .views .format.tab {
        display: inline-block;
      }

      .views .format.tab a {
        padding: 8px 0 6px 0;
        border-radius: 0;
        background: transparent;
        color: #666;
        text-decoration: none;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
        display: inline-block;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        margin-right: 16px;
        outline: none;
      }

      .views .format.tab a:hover {
        color: #1a1a1a;
        text-decoration: none;
      }

      .views .format.tab a:focus {
        outline: none;
      }

      .views .format.tab.selected a,
      .views .format.tab a.selected {
        color: #2196F3 !important;
        border-bottom: 3px solid #2196F3;
        text-decoration: none !important;
      }

      .views .format.tab.selected a:hover,
      .views .format.tab a.selected:hover {
        color: #1976D2;
        border-bottom-color: #1976D2;
      }

      .download-btn {
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #ffffff;
        color: #1a1a1a;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
        text-decoration: none;
      }

      .download-btn:hover {
        background: #f8f8f8;
        border-color: #d0d0d0;
      }

      .download-icon {
        width: 14px;
        height: 14px;
        display: inline-block;
      }

      #message iframe.body {
        flex: 1;
        border: none;
        background: #ffffff;
      }

      #message iframe.body[src*=".source"] {
        background: #f5f5f5;
      }

      #noscript-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      #noscript {
        text-align: center;
        font-size: 18px;
        color: #333;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f0f0f0;
      }

      ::-webkit-scrollbar-thumb {
        background: #d0d0d0;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #b0b0b0;
      }

      /* Email Signature Info Button */
      .signature-info-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        padding: 0;
        border: none;
        background: #e3f2fd;
        color: #1976D2;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
        flex-shrink: 0;
        margin-left: 8px;
      }

      .signature-info-btn:hover {
        background: #bbdefb;
        color: #1565c0;
        transform: scale(1.05);
      }

      .signature-info-btn:active {
        transform: scale(0.95);
      }

      .signature-info-btn svg {
        width: 18px;
        height: 18px;
      }

      /* Encryption/Signature Tooltip Styling */
      .encryption-tooltip-content {
        padding: 12px 16px;
        font-size: 13px;
        line-height: 1.6;
        max-width: 400px;
      }

      .encryption-tooltip-content h3 {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #5f5f5f;
        margin: 0 0 8px 0;
        padding-top: 8px;
      }

      .encryption-tooltip-content h3:first-child {
        padding-top: 0;
        margin-top: 0;
      }

      .encryption-info-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 6px;
      }

      .encryption-info-item:last-child {
        margin-bottom: 0;
      }

      .encryption-info-label {
        font-weight: 500;
        color: #333;
        min-width: 100px;
      }

      .encryption-info-value {
        color: #666;
        flex-grow: 1;
        word-break: break-all;
      }

      .encryption-copy-button {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 12px;
        margin-top: 8px;
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        color: #333;
        transition: all 0.2s;
      }

      .encryption-copy-button:hover {
        background: #efefef;
        border-color: #d0d0d0;
      }

      .encryption-copy-button:active {
        transform: scale(0.98);
      }

      .encryption-copy-button svg {
        width: 14px;
        height: 14px;
      }

      .encryption-copy-button.copied {
        background: #c8e6c9;
        border-color: #4caf50;
        color: #2e7d32;
      }

      .encryption-copy-button.copied svg {
        stroke: #2e7d32;
      }

      .encryption-no-data {
        color: #999;
        font-size: 12px;
      }

      /* Tippy tooltip customization */
      .tippy-box[data-theme~='light'] {
        background-color: #ffffff;
        border: 1px solid #e8eaed;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        border-radius: 8px;
        color: #1a1a1a;
      }

      .tippy-box[data-theme~='light'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: #e8eaed;
      }

      .tippy-box[data-theme~='light'][data-placement^='bottom'] > .tippy-arrow::before {
        border-bottom-color: #e8eaed;
      }

      .tippy-box[data-theme~='light'][data-placement^='left'] > .tippy-arrow::before {
        border-left-color: #e8eaed;
      }

      .tippy-box[data-theme~='light'][data-placement^='right'] > .tippy-arrow::before {
        border-right-color: #e8eaed;
      }

      .signature-tooltip-content {
        padding: 12px 16px;
        font-size: 13px;
        line-height: 1.6;
        max-width: 360px;
      }

      .signature-tooltip-content h3 {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #5f5f5f;
        margin: 0 0 8px 0;
        padding-top: 8px;
      }

      .signature-tooltip-content h3:first-child {
        padding-top: 0;
        margin-top: 0;
      }

      .signature-tooltip-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .signature-tooltip-item:last-child {
        margin-bottom: 0;
      }

      .signature-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
      }

      .signature-status-badge.pass {
        background: #c8e6c9;
        color: #2e7d32;
      }

      .signature-status-badge.fail {
        background: #ffcdd2;
        color: #c62828;
      }

      .signature-status-badge.neutral {
        background: #f5f5f5;
        color: #666;
      }

      .signature-status-badge::before {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
        content: '';
      }

      /* Syntax highlighting for HTML source */
      pre {
        margin: 0;
        padding: 16px;
        background: #ffffff;
        border: 1px solid #e8eaed;
        border-radius: 8px;
        overflow-x: auto;
        font-family: 'Courier New', 'Monaco', 'Ubuntu Mono', monospace;
        font-size: 12px;
        line-height: 1.5;
      }

      code {
        background: transparent;
        padding: 0;
        font-family: inherit;
        font-size: inherit;
        color: #1a1a1a;
      }

      /* Override highlight.js default styles for light theme compatibility */
      .hljs {
        background: #ffffff;
        color: #1a1a1a;
      }

      .hljs-tag {
        color: #2196F3;
      }

      .hljs-attr {
        color: #2196F3;
      }

      .hljs-string {
        color: #34a853;
      }

      .hljs-number {
        color: #ea4335;
      }

      .hljs-literal {
        color: #ea4335;
      }
    </style>
  </head>
  <body>
    <noscript>
      <div id="noscript-overlay">
        <div id="noscript">
          MailCatcher requires JavaScript to be enabled.
        </div>
      </div>
    </noscript>
    <header>
      <div>
        <h1><a href="https://spaquet.github.io/mailcatcher/" target="_blank">MailCatcher</a></h1>
        <div class="version-badge"><%= @version %></div>
      </div>
      <div class="header-controls">
        <div class="search-box">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="search" name="search" placeholder="Search messages..." incremental="true" />
          <button type="button" class="search-clear" id="searchClear" title="Clear search">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="attachment-filter">
          <select id="attachmentFilter" title="Filter by attachments">
            <option value="all">All</option>
            <option value="with">With attachments</option>
            <option value="without">Without attachments</option>
          </select>
        </div>
        <div class="header-info">
          <div class="status-badge" id="websocketStatus">
            <div class="indicator"></div>
            <span id="statusText">Connected</span>
          </div>
          <div class="email-count" id="emailCount">0 emails</div>
          <div class="action-buttons">
            <button class="btn" id="serverInfoBtn" title="View server information">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="2" y1="17" x2="22" y2="17"></line>
                <polyline points="15 21 12 17 9 21"></polyline>
              </svg>
              Server
            </button>
            <button class="btn" id="clearBtn" title="Clear all messages">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
              Clear
            </button>
            <% if MailCatcher.quittable? %>
              <button class="btn" id="quitBtn" title="Quit MailCatcher">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 6 13.46 15.89"></polyline>
                  <polyline points="23 6 6.21 23"></polyline>
                  <polyline points="1 1 21 21"></polyline>
                </svg>
                Quit
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </header>
    <main>
      <nav id="messages">
        <table>
          <thead>
            <tr>
              <th class="col-attachments"></th>
              <th class="col-bimi"></th>
              <th>From</th>
              <th>To</th>
              <th>Subject</th>
              <th>Received</th>
              <th>Size</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </nav>
      <div id="resizer"></div>
      <article id="message">
        <header>
          <div class="views-container">
            <nav class="views">
              <ul class="views-tabs">
                <li class="format tab html selected" data-message-format="html"><a href="#">HTML</a></li>
                <li class="format tab plain" data-message-format="plain"><a href="#">Plain Text</a></li>
                <li class="format tab source" data-message-format="source"><a href="#">Source</a></li>
              </ul>
              <ul class="views-actions">
                <li><button class="signature-info-btn" id="encryptionInfoBtn" title="Email encryption and signature information">
                  <svg data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"></path>
                  </svg>
                </button></li>
                <li><button class="signature-info-btn" id="signatureInfoBtn" title="Email signature verification (DMARC, DKIM, SPF)">
                  <svg data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z"></path>
                  </svg>
                </button></li>
                <li><a href="#" class="download-btn" data-message-format="html">
                  <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Download
                </a></li>
              </ul>
            </nav>
          </div>
          <div class="metadata">
            <div class="metadata-column">
              <div class="metadata-item">
                <dt class="created_at">Received</dt>
                <dd class="created_at"></dd>
              </div>
              <div class="metadata-item">
                <dt class="from">From</dt>
                <dd class="from"></dd>
              </div>
              <div class="metadata-item">
                <dt class="to">To</dt>
                <dd class="to"></dd>
              </div>
              <div class="metadata-item">
                <dt class="subject">Subject</dt>
                <dd class="subject"></dd>
              </div>
            </div>
          </div>
          <div class="attachments-column">
            <div class="attachments-header">Attachments</div>
            <ul class="attachments-list"></ul>
          </div>
        </header>
        <iframe class="body"></iframe>
      </article>
    </main>
    <script>
      // Update email count display
      function updateEmailCount() {
        const count = document.querySelectorAll('#messages tbody tr').length;
        document.getElementById('emailCount').textContent = count === 1 ? '1 email' : count + ' emails';
      }

      // Setup additional UI handlers
      document.addEventListener('DOMContentLoaded', function() {
        // Patch the original refresh to update email count
        const originalRefresh = window.MailCatcher?.refresh;
        if (originalRefresh) {
          window.MailCatcher.refresh = function() {
            originalRefresh.call(this);
            updateEmailCount();
          };
        }

        // Setup resizer drag functionality
        const resizer = document.getElementById('resizer');
        const messagesSection = document.getElementById('messages');
        let isResizing = false;

        if (resizer && messagesSection) {
          resizer.addEventListener('mousedown', function(e) {
            e.preventDefault();
            isResizing = true;
            const startY = e.clientY;
            const startHeight = messagesSection.offsetHeight;

            const handleMouseMove = (e) => {
              if (!isResizing) return;
              const delta = e.clientY - startY;
              const newHeight = Math.max(150, startHeight + delta);
              messagesSection.style.flex = `0 0 ${newHeight}px`;
              localStorage.setItem('mailcatcherSeparatorHeight', newHeight);
            };

            const handleMouseUp = () => {
              isResizing = false;
              document.removeEventListener('mousemove', handleMouseMove);
              document.removeEventListener('mouseup', handleMouseUp);
            };

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          });
        }

        // Restore saved resizer position
        const savedHeight = localStorage.getItem('mailcatcherSeparatorHeight');
        if (savedHeight && messagesSection) {
          messagesSection.style.flex = `0 0 ${savedHeight}px`;
        }

        // Setup button handlers
        document.getElementById('serverInfoBtn').addEventListener('click', function(e) {
          e.preventDefault();
          window.location.href = new URL('server-info', document.baseURI).toString();
        });

        document.getElementById('clearBtn').addEventListener('click', function(e) {
          e.preventDefault();
          if (window.MailCatcher && document.querySelectorAll('#messages tbody tr').length > 0) {
            const confirmText = 'You will lose all your received messages.\n\nAre you sure you want to clear all messages?';
            if (confirm(confirmText)) {
              window.MailCatcher.clearMessages();
              // Also send DELETE request
              fetch(new URL('messages', document.baseURI).toString(), { method: 'DELETE' });
            }
          }
        });

        const quitBtn = document.getElementById('quitBtn');
        if (quitBtn) {
          quitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const confirmText = 'You will lose all your received messages.\n\nAre you sure you want to quit?';
            if (confirm(confirmText)) {
              fetch(new URL('', document.baseURI).toString(), { method: 'DELETE' });
            }
          });
        }

        // Monitor updates for email count
        const observer = new MutationObserver(() => updateEmailCount());
        const tbody = document.querySelector('#messages tbody');
        if (tbody) {
          observer.observe(tbody, { childList: true });
        }

        // Handle download button
        document.querySelector('.download-btn').addEventListener('click', function(e) {
          e.preventDefault();
          if (window.MailCatcher) {
            const id = window.MailCatcher.selectedMessage();
            if (id) {
              window.location.href = `messages/${id}.eml`;
            }
          }
        });

        // Setup email signature info tooltip
        const signatureInfoBtn = document.getElementById('signatureInfoBtn');
        let signatureTooltip = null;

        function getStatusBadgeClass(status) {
          if (!status) return 'neutral';
          return status === 'pass' ? 'pass' : status === 'fail' ? 'fail' : 'neutral';
        }

        function getStatusLabel(status) {
          if (!status) return 'Not checked';
          return status.charAt(0).toUpperCase() + status.slice(1);
        }

        function generateSignatureContent(authResults) {
          const dmarc = authResults?.dmarc;
          const dkim = authResults?.dkim;
          const spf = authResults?.spf;

          // Check if any auth data exists
          const hasAuthData = dmarc || dkim || spf;

          if (!hasAuthData) {
            return `
              <div class="signature-tooltip-content">
                <p style="color: #999; font-size: 12px;">No authentication headers found for this email.</p>
              </div>
            `;
          }

          return `
            <div class="signature-tooltip-content">
              ${dmarc ? `
                <h3>DMARC</h3>
                <div class="signature-tooltip-item">
                  <span class="signature-status-badge ${getStatusBadgeClass(dmarc)}">
                    ${getStatusLabel(dmarc)}
                  </span>
                </div>
              ` : ''}
              ${dkim ? `
                <h3>DKIM</h3>
                <div class="signature-tooltip-item">
                  <span class="signature-status-badge ${getStatusBadgeClass(dkim)}">
                    ${getStatusLabel(dkim)}
                  </span>
                </div>
              ` : ''}
              ${spf ? `
                <h3>SPF</h3>
                <div class="signature-tooltip-item">
                  <span class="signature-status-badge ${getStatusBadgeClass(spf)}">
                    ${getStatusLabel(spf)}
                  </span>
                </div>
              ` : ''}
            </div>
          `;
        }

        if (signatureInfoBtn) {
          signatureInfoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.MailCatcher) {
              const messageId = window.MailCatcher.selectedMessage();
              if (!messageId) return;

              // Destroy existing tooltip if any
              if (signatureTooltip) {
                signatureTooltip.destroy();
              }

              // Fetch message data
              fetch(new URL(`messages/${messageId}.json`, document.baseURI).toString())
                .then(response => response.json())
                .then(data => {
                  const authResults = data.authentication_results || {};
                  const content = generateSignatureContent(authResults);

                  // Create tooltip with content
                  signatureTooltip = tippy(signatureInfoBtn, {
                    content: content,
                    allowHTML: true,
                    theme: 'light',
                    placement: 'bottom-start',
                    interactive: true,
                    duration: [200, 150],
                    arrow: true,
                    trigger: 'manual',
                    maxWidth: 360,
                    onClickOutside: (instance) => {
                      instance.hide();
                    },
                  });

                  // Show tooltip
                  signatureTooltip.show();
                })
                .catch(error => {
                  console.error('Error fetching signature data:', error);
                  const errorContent = `
                    <div class="signature-tooltip-content">
                      <p style="color: #999; font-size: 12px;">Error loading signature data.</p>
                    </div>
                  `;

                  signatureTooltip = tippy(signatureInfoBtn, {
                    content: errorContent,
                    allowHTML: true,
                    theme: 'light',
                    placement: 'bottom-start',
                    interactive: true,
                    duration: [200, 150],
                    arrow: true,
                    trigger: 'manual',
                    onClickOutside: (instance) => {
                      instance.hide();
                    },
                  });

                  signatureTooltip.show();
                });
            }
          });

          // Close tooltip when clicking elsewhere
          document.addEventListener('click', function(e) {
            // Check if this click is on the button
            if (signatureInfoBtn && signatureInfoBtn.contains(e.target)) return;

            // Check if this click is on a tippy-box
            if (e.target.closest('.tippy-box')) return;

            // Click is outside everything, hide tooltip
            if (signatureTooltip) {
              signatureTooltip.hide();
            }

            // Also ensure any visible tippy-box is hidden
            const visibleBoxes = document.querySelectorAll('.tippy-box[data-state="visible"]');
            visibleBoxes.forEach(box => {
              box.style.visibility = 'hidden';
              box.style.pointerEvents = 'none';
            });
          });
        }

        // Setup encryption/signature info tooltip
        const encryptionInfoBtn = document.getElementById('encryptionInfoBtn');
        let encryptionTooltip = null;

        function generateEncryptionContent(encryptionData) {
          const smime = encryptionData?.smime;
          const pgp = encryptionData?.pgp;

          // Check if any encryption data exists
          const hasEncryptionData = smime || pgp;

          if (!hasEncryptionData) {
            return `
              <div class="encryption-tooltip-content">
                <p class="encryption-no-data">No encryption or signature information found for this email.</p>
              </div>
            `;
          }

          let content = '<div class="encryption-tooltip-content">';

          if (smime) {
            content += `
              <h3>S/MIME</h3>
              ${smime.certificate ? `
                <div class="encryption-info-item">
                  <span class="encryption-info-label">Certificate:</span>
                  <span class="encryption-info-value">${escapeHtml(smime.certificate.substring(0, 40))}...</span>
                </div>
                <button class="encryption-copy-button" data-copy-type="smime-cert" data-value="${escapeHtml(smime.certificate)}">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z"></path>
                  </svg>
                  Copy Certificate
                </button>
              ` : ''}
              ${smime.signature ? `
                <div class="encryption-info-item">
                  <span class="encryption-info-label">Signature:</span>
                  <span class="encryption-info-value">${escapeHtml(smime.signature.substring(0, 40))}...</span>
                </div>
                <button class="encryption-copy-button" data-copy-type="smime-sig" data-value="${escapeHtml(smime.signature)}">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z"></path>
                  </svg>
                  Copy Signature
                </button>
              ` : ''}
            `;
          }

          if (pgp) {
            content += `
              <h3>OpenPGP</h3>
              ${pgp.key ? `
                <div class="encryption-info-item">
                  <span class="encryption-info-label">Key:</span>
                  <span class="encryption-info-value">${escapeHtml(pgp.key.substring(0, 40))}...</span>
                </div>
                <button class="encryption-copy-button" data-copy-type="pgp-key" data-value="${escapeHtml(pgp.key)}">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z"></path>
                  </svg>
                  Copy Key
                </button>
              ` : ''}
              ${pgp.signature ? `
                <div class="encryption-info-item">
                  <span class="encryption-info-label">Signature:</span>
                  <span class="encryption-info-value">${escapeHtml(pgp.signature.substring(0, 40))}...</span>
                </div>
                <button class="encryption-copy-button" data-copy-type="pgp-sig" data-value="${escapeHtml(pgp.signature)}">
                  <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z"></path>
                  </svg>
                  Copy Signature
                </button>
              ` : ''}
            `;
          }

          content += '</div>';
          return content;
        }

        function escapeHtml(text) {
          const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          };
          return text.replace(/[&<>"']/g, m => map[m]);
        }

        if (encryptionInfoBtn) {
          encryptionInfoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.MailCatcher) {
              const messageId = window.MailCatcher.selectedMessage();
              if (!messageId) return;

              // Destroy existing tooltip if any
              if (encryptionTooltip) {
                encryptionTooltip.destroy();
              }

              // Fetch message data
              fetch(new URL(`messages/${messageId}.json`, document.baseURI).toString())
                .then(response => response.json())
                .then(data => {
                  const encryptionData = data.encryption_data || {};
                  const content = generateEncryptionContent(encryptionData);

                  // Create tooltip with content
                  encryptionTooltip = tippy(encryptionInfoBtn, {
                    content: content,
                    allowHTML: true,
                    theme: 'light',
                    placement: 'bottom-start',
                    interactive: true,
                    duration: [200, 150],
                    arrow: true,
                    trigger: 'manual',
                    maxWidth: 400,
                    onClickOutside: (instance) => {
                      instance.hide();
                    },
                  });

                  // Show tooltip
                  encryptionTooltip.show();

                  // Setup copy button handlers
                  const copyButtons = document.querySelectorAll('.encryption-copy-button');
                  copyButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                      e.preventDefault();
                      e.stopPropagation();

                      const value = this.getAttribute('data-value');
                      const copyType = this.getAttribute('data-copy-type');

                      // Copy to clipboard
                      navigator.clipboard.writeText(value).then(() => {
                        // Show success state
                        const originalHTML = this.innerHTML;
                        const originalClass = this.className;

                        this.classList.add('copied');
                        this.innerHTML = `
                          <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.35 3.836c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m8.9-4.414c.376.023.75.05 1.124.08 1.131.094 1.976 1.057 1.976 2.192V16.5A2.25 2.25 0 0 1 18 18.75h-2.25m-7.5-10.5H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V18.75m-7.5-10.5h6.375c.621 0 1.125.504 1.125 1.125v9.375m-8.25-3 1.5 1.5 3-3.75"></path>
                          </svg>
                          Copied!
                        `;

                        // Reset after 3 seconds
                        setTimeout(() => {
                          this.className = originalClass;
                          this.innerHTML = originalHTML;
                        }, 3000);
                      }).catch(err => {
                        console.error('Failed to copy to clipboard:', err);
                      });
                    });
                  });
                })
                .catch(error => {
                  console.error('Error fetching encryption data:', error);
                  const errorContent = `
                    <div class="encryption-tooltip-content">
                      <p class="encryption-no-data">Error loading encryption data.</p>
                    </div>
                  `;

                  encryptionTooltip = tippy(encryptionInfoBtn, {
                    content: errorContent,
                    allowHTML: true,
                    theme: 'light',
                    placement: 'bottom-start',
                    interactive: true,
                    duration: [200, 150],
                    arrow: true,
                    trigger: 'manual',
                    onClickOutside: (instance) => {
                      instance.hide();
                    },
                  });

                  encryptionTooltip.show();
                });
            }
          });

          // Close tooltip when clicking elsewhere
          document.addEventListener('click', function(e) {
            // Check if this click is on the button
            if (encryptionInfoBtn && encryptionInfoBtn.contains(e.target)) return;

            // Check if this click is on a tippy-box
            if (e.target.closest('.tippy-box')) return;

            // Click is outside everything, hide tooltip
            if (encryptionTooltip) {
              encryptionTooltip.hide();
            }
          });
        }
      });
    </script>
  </body>
</html>
