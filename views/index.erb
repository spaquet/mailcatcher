<!DOCTYPE html>
<html class="mailcatcher">
<head>
  <title>MailCatcher</title>
  <base href="<%= settings.prefix.chomp("/") %>/">
  <link href="favicon.ico" rel="icon">
  <script src="<%= asset_path("mailcatcher.js") %>"></script>
  <style>
    /* MailCatcher UI Styles - Complete inline stylesheet
       This is the single source of truth for all MailCatcher UI styling.
       No external CSS files are loaded (old Sass assets are deprecated).
       All changes should be made here for modern, responsive design.
    */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: #ffffff;
      color: #1a1a1a;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
      border-bottom: 1px solid #e8eaed;
      padding: 20px 28px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }

    header h1 a {
      color: #2196F3;
      text-decoration: none;
      transition: color 0.2s;
    }

    header h1 a:hover {
      color: #1976D2;
    }

    .header-controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 280px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 9px 14px 9px 36px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      background: #ffffff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: #999;
      pointer-events: none;
    }

    .header-info {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #f0f0f0;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .status-badge .indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #34a853;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .status-badge.disconnected .indicator {
      background: #ea4335;
      animation: none;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #2196F3;
      color: #ffffff;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: #1976D2;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .email-count {
      font-size: 13px;
      color: #5f5f5f;
      padding: 8px 12px;
      background: #f9f9f9;
      border-radius: 6px;
    }

    main {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    #messages {
      flex: 0 0 300px;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border-bottom: 1px solid #e8eaed;
      overflow: hidden;
      min-height: 150px;
    }

    #resizer {
      width: 100%;
      height: 8px;
      background: #e8eaed;
      cursor: row-resize;
      flex-shrink: 0;
      transition: background 0.2s;
      position: relative;
      z-index: 5;
      user-select: none;
    }

    #resizer:hover {
      background: #2196F3;
    }

    #resizer .ruler {
      display: none;
    }

    #messages table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #messages thead {
      background: #f9f9f9;
      border-bottom: 1px solid #e8eaed;
      position: sticky;
      top: 0;
      z-index: 10;
      flex-shrink: 0;
      display: flex;
      width: 100%;
    }

    #messages thead tr {
      display: flex;
      width: 100%;
    }

    #messages th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: #5f5f5f;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #messages tbody {
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    #messages tbody tr {
      display: flex;
      width: 100%;
      flex-shrink: 0;
    }

    #messages tr {
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.15s;
    }

    #messages tr:hover {
      background-color: #f9f9f9;
    }

    #messages tr.selected {
      background-color: #f0f4ff;
    }

    #messages tr.selected:hover {
      background-color: #e6ecff;
    }

    #messages td {
      padding: 12px 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    #messages td.blank {
      color: #999;
      font-style: italic;
    }

    #message {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      overflow: hidden;
    }

    #message > header {
      border-bottom: 1px solid #e8eaed;
      padding: 12px 28px;
      background: #f9f9f9;
      overflow-y: auto;
      max-height: 40%;
      flex-shrink: 0;
    }

    .metadata {
      display: grid;
      grid-template-columns: 90px 1fr;
      gap: 2px 20px;
      margin-bottom: 12px;
    }

    .metadata dt {
      font-weight: 600;
      color: #5f5f5f;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      line-height: 1.2;
    }

    .metadata dd {
      color: #1a1a1a;
      font-size: 11px;
      word-break: break-word;
      line-height: 1.2;
    }

    .views-container {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e8eaed;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .views {
      display: flex;
      gap: 8px;
      flex: 1;
    }

    .views ul {
      list-style: none;
      display: flex;
      gap: 8px;
    }

    .views .format.tab {
      display: inline-block;
    }

    .views .format.tab a {
      padding: 8px 0 6px 0;
      border-radius: 0;
      background: transparent;
      color: #666;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-block;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      margin-right: 16px;
      outline: none;
    }

    .views .format.tab a:hover {
      color: #1a1a1a;
      text-decoration: none;
    }

    .views .format.tab a:focus {
      outline: none;
    }

    .views .format.tab.selected a,
    .views .format.tab a.selected {
      color: #2196F3 !important;
      border-bottom: 3px solid #2196F3;
      text-decoration: none !important;
    }

    .views .format.tab.selected a:hover,
    .views .format.tab a.selected:hover {
      color: #1976D2;
      border-bottom-color: #1976D2;
    }

    .download-btn {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #ffffff;
      color: #1a1a1a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
      text-decoration: none;
    }

    .download-btn:hover {
      background: #f8f8f8;
      border-color: #d0d0d0;
    }

    .download-icon {
      width: 14px;
      height: 14px;
      display: inline-block;
    }

    #message iframe.body {
      flex: 1;
      border: none;
      background: #ffffff;
    }

    #noscript-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #noscript {
      text-align: center;
      font-size: 18px;
      color: #333;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f0f0f0;
    }

    ::-webkit-scrollbar-thumb {
      background: #d0d0d0;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #b0b0b0;
    }
  </style>
</head>
<body>
  <noscript>
    <div id="noscript-overlay">
      <div id="noscript">
        MailCatcher requires JavaScript to be enabled.
      </div>
    </div>
  </noscript>

  <header>
    <h1><a href="https://mailcatcher.me" target="_blank">MailCatcher</a></h1>
    <div class="header-controls">
      <div class="search-box">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="search" name="search" placeholder="Search messages..." incremental="true" />
      </div>
      <div class="header-info">
        <div class="status-badge" id="websocketStatus">
          <div class="indicator"></div>
          <span id="statusText">Connected</span>
        </div>
        <div class="email-count" id="emailCount">0 emails</div>
        <div class="action-buttons">
          <button class="btn" id="clearBtn" title="Clear all messages">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Clear
          </button>
          <% if MailCatcher.quittable? %>
            <button class="btn" id="quitBtn" title="Quit MailCatcher">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 6 13.46 15.89"></polyline>
                <polyline points="23 6 6.21 23"></polyline>
                <polyline points="1 1 21 21"></polyline>
              </svg>
              Quit
            </button>
          <% end %>
        </div>
      </div>
    </div>
  </header>

  <main>
    <nav id="messages">
      <table>
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Subject</th>
            <th>Received</th>
            <th>Size</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </nav>

    <div id="resizer"></div>

    <article id="message">
      <header>
        <dl class="metadata">
          <dt class="created_at">Received</dt>
          <dd class="created_at"></dd>
          <dt class="from">From</dt>
          <dd class="from"></dd>
          <dt class="to">To</dt>
          <dd class="to"></dd>
          <dt class="subject">Subject</dt>
          <dd class="subject"></dd>
          <dt class="attachments">Attachments</dt>
          <dd class="attachments"></dd>
        </dl>
        <div class="views-container">
          <nav class="views">
            <ul>
              <li class="format tab html selected" data-message-format="html"><a href="#">HTML</a></li>
              <li class="format tab plain" data-message-format="plain"><a href="#">Plain Text</a></li>
              <li class="format tab source" data-message-format="source"><a href="#">Source</a></li>
            </ul>
          </nav>
          <a href="#" class="download-btn" data-message-format="html">
            <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download
          </a>
        </div>
      </header>
      <iframe class="body"></iframe>
    </article>
  </main>

  <script>
    // Update email count display
    function updateEmailCount() {
      const count = document.querySelectorAll('#messages tbody tr').length;
      document.getElementById('emailCount').textContent = count === 1 ? '1 email' : count + ' emails';
    }

    // Setup additional UI handlers
    document.addEventListener('DOMContentLoaded', function() {
      // Patch the original refresh to update email count
      const originalRefresh = window.MailCatcher?.refresh;
      if (originalRefresh) {
        window.MailCatcher.refresh = function() {
          originalRefresh.call(this);
          updateEmailCount();
        };
      }

      // Setup resizer drag functionality
      const resizer = document.getElementById('resizer');
      const messagesSection = document.getElementById('messages');
      let isResizing = false;

      if (resizer && messagesSection) {
        resizer.addEventListener('mousedown', function(e) {
          e.preventDefault();
          isResizing = true;
          const startY = e.clientY;
          const startHeight = messagesSection.offsetHeight;

          const handleMouseMove = (e) => {
            if (!isResizing) return;
            const delta = e.clientY - startY;
            const newHeight = Math.max(150, startHeight + delta);
            messagesSection.style.flex = `0 0 ${newHeight}px`;
            localStorage.setItem('mailcatcherSeparatorHeight', newHeight);
          };

          const handleMouseUp = () => {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
          };

          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        });
      }

      // Restore saved resizer position
      const savedHeight = localStorage.getItem('mailcatcherSeparatorHeight');
      if (savedHeight && messagesSection) {
        messagesSection.style.flex = `0 0 ${savedHeight}px`;
      }

      // Setup button handlers
      document.getElementById('clearBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (window.MailCatcher && document.querySelectorAll('#messages tbody tr').length > 0) {
          const confirmText = 'You will lose all your received messages.\n\nAre you sure you want to clear all messages?';
          if (confirm(confirmText)) {
            window.MailCatcher.clearMessages();
            // Also send DELETE request
            fetch(new URL('messages', document.baseURI).toString(), { method: 'DELETE' });
          }
        }
      });

      const quitBtn = document.getElementById('quitBtn');
      if (quitBtn) {
        quitBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const confirmText = 'You will lose all your received messages.\n\nAre you sure you want to quit?';
          if (confirm(confirmText)) {
            fetch(new URL('', document.baseURI).toString(), { method: 'DELETE' });
          }
        });
      }

      // Monitor updates for email count
      const observer = new MutationObserver(() => updateEmailCount());
      const tbody = document.querySelector('#messages tbody');
      if (tbody) {
        observer.observe(tbody, { childList: true });
      }

      // Handle download button
      document.querySelector('.download-btn').addEventListener('click', function(e) {
        e.preventDefault();
        if (window.MailCatcher) {
          const id = window.MailCatcher.selectedMessage();
          if (id) {
            window.location.href = `messages/${id}.eml`;
          }
        }
      });
    });
  </script>
</body>
</html>
