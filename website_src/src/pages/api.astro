---
import Layout from '../layouts/Layout.astro';
import ApiSidebar from '../components/ApiSidebar.astro';
import CodeBlock from '../components/CodeBlock.astro';
import { Icon } from 'astro-icon/components';
---

<Layout title="REST API - MailCatcher NG" description="Complete REST API documentation for MailCatcher NG." currentPage="api">
  <div class="flex">
    {/* Sidebar */}
    <ApiSidebar />

    {/* Main Content */}
    <div class="flex-1">
      {/* Header */}
      <section class="bg-forest-50 border-b border-forest-200 py-12 px-6 sm:px-8 lg:px-12">
        <div class="max-w-5xl">
          <h1 class="font-display text-4xl font-bold text-anthracite mb-4">REST API</h1>
          <p class="text-gray-600 max-w-2xl">Complete API reference for MailCatcher NG. All endpoints are local only and require no authentication.</p>

          <div class="mt-8 flex flex-col sm:flex-row items-start sm:items-center gap-6">
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2">
                <span class="font-mono font-bold text-blue-600">GET</span>
                <span class="text-gray-600 text-sm">Retrieve data</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-mono font-bold text-green-600">POST</span>
                <span class="text-gray-600 text-sm">Create/Execute</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-mono font-bold text-red-600">DELETE</span>
                <span class="text-gray-600 text-sm">Remove data</span>
              </div>
            </div>

            {/* Code Examples CTA */}
            <a href="/mailcatcher/api/examples/" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-forest-600 text-white font-semibold text-sm hover:bg-forest-700 transition-colors duration-200 whitespace-nowrap">
              <Icon name="mdi:code-braces" class="w-4 h-4" />
              View Code Examples
            </a>
          </div>
        </div>
      </section>

      {/* Content */}
      <section class="py-12 px-6 sm:px-8 lg:px-12">
        <div class="max-w-5xl space-y-16">

          {/* Basic Operations */}
          <div>
            <h2 class="font-display text-2xl font-bold text-anthracite mb-8">Basic Operations</h2>
            <div class="space-y-8">

              {/* List Messages */}
              <div id="list-messages" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages</code>
                </div>
                <p class="text-gray-700 mb-6">Returns JSON array of all messages with basic metadata.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages`}
                  language="bash"
                  title="Request"
                />
                <h4 class="font-display font-semibold text-anthracite mt-6 mb-3">Response</h4>
                <CodeBlock
                  code={`[
  {
    "id": 1,
    "from": ["sender@example.com"],
    "to": ["recipient@example.com"],
    "subject": "Test Email",
    "created_at": "2024-01-10T10:30:00Z"
  }
]`}
                  language="json"
                />
              </div>

              {/* Get Message Metadata */}
              <div id="get-metadata" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id.json</code>
                </div>
                <p class="text-gray-700 mb-6">Returns detailed metadata for a specific message including headers, sender, recipients, and body info.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1.json`}
                  language="bash"
                />
              </div>

              {/* Get HTML Content */}
              <div id="get-html" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id.html</code>
                </div>
                <p class="text-gray-700 mb-6">Returns the HTML version of the message rendered in the browser.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1.html`}
                  language="bash"
                />
              </div>

              {/* Get Plain Text */}
              <div id="get-plain" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id.plain</code>
                </div>
                <p class="text-gray-700 mb-6">Returns the plain text version of the message.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1.plain`}
                  language="bash"
                />
              </div>

              {/* Get Message Source */}
              <div id="get-source" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id.source</code>
                </div>
                <p class="text-gray-700 mb-6">Returns the complete raw email source in MIME format.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1.source`}
                  language="bash"
                />
              </div>

              {/* Download EML */}
              <div id="download-eml" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id.eml</code>
                </div>
                <p class="text-gray-700 mb-6">Downloads the message as an EML file (RFC 822), suitable for importing into email clients.</p>
                <CodeBlock
                  code={`curl -O http://127.0.0.1:1080/messages/1.eml`}
                  language="bash"
                />
              </div>
            </div>
          </div>

          {/* Advanced Operations */}
          <div>
            <h2 class="font-display text-2xl font-bold text-anthracite mb-8">Advanced Operations</h2>
            <div class="space-y-8">

              {/* SMTP Transcript JSON */}
              <div id="get-transcript-json" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id/transcript.json</code>
                </div>
                <p class="text-gray-700 mb-6">Returns the SMTP transcript including all commands, responses, and TLS details for debugging connection issues.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1/transcript.json`}
                  language="bash"
                  title="Request"
                />
                <h4 class="font-display font-semibold text-anthracite mt-6 mb-3">Includes</h4>
                <ul class="text-sm text-gray-700 space-y-1 mb-4">
                  <li>• Session ID and client/server connection details</li>
                  <li>• TLS protocol version and cipher suite</li>
                  <li>• Complete SMTP command/response transcript</li>
                  <li>• Connection timing information</li>
                </ul>
              </div>

              {/* SMTP Transcript HTML */}
              <div id="get-transcript-html" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id.transcript</code>
                </div>
                <p class="text-gray-700 mb-6">Returns SMTP transcript rendered as an HTML page for viewing in a browser.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1.transcript`}
                  language="bash"
                />
              </div>

              {/* Download Attachment */}
              <div id="get-parts" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id/parts/:cid</code>
                </div>
                <p class="text-gray-700 mb-6">Downloads a specific message part or attachment by its Content-ID.</p>
                <CodeBlock
                  code={`# First, get the message metadata to find attachment CIDs
curl http://127.0.0.1:1080/messages/1.json | jq '.parts'

# Then download the attachment
curl -O http://127.0.0.1:1080/messages/1/parts/image-001`}
                  language="bash"
                />
              </div>

              {/* Search Messages */}
              <div id="search-messages" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/search</code>
                </div>
                <p class="text-gray-700 mb-6">Search messages across subject, sender, recipient, and body content with optional filtering.</p>
                <h4 class="font-display font-semibold text-anthracite mb-3 mt-6">Query Parameters</h4>
                <div class="space-y-2 text-sm text-gray-700 mb-6">
                  <p><code class="bg-gray-200 px-2 py-1 rounded">q</code> - Search query (required)</p>
                  <p><code class="bg-gray-200 px-2 py-1 rounded">has_attachments</code> - Filter by attachments (true/false)</p>
                  <p><code class="bg-gray-200 px-2 py-1 rounded">from</code> - Start date (ISO 8601)</p>
                  <p><code class="bg-gray-200 px-2 py-1 rounded">to</code> - End date (ISO 8601)</p>
                </div>
                <CodeBlock
                  code={`curl "http://127.0.0.1:1080/messages/search?q=verification&has_attachments=false"

curl "http://127.0.0.1:1080/messages/search?q=noreply@example.com&from=2024-01-01&to=2024-01-31"`}
                  language="bash"
                />
              </div>

              {/* Extract Tokens/OTP */}
              <div id="extract-tokens" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id/extract</code>
                </div>
                <p class="text-gray-700 mb-6">Extracts verification tokens, magic links, OTP codes, or reset tokens from message content.</p>
                <h4 class="font-display font-semibold text-anthracite mb-3 mt-6">Query Parameters</h4>
                <div class="space-y-2 text-sm text-gray-700 mb-6">
                  <p><code class="bg-gray-200 px-2 py-1 rounded">type</code> - Type to extract: <code>token</code>, <code>link</code>, or <code>otp</code></p>
                </div>
                <CodeBlock
                  code={`# Extract OTP code
curl "http://127.0.0.1:1080/messages/1/extract?type=otp"

# Extract magic link
curl "http://127.0.0.1:1080/messages/1/extract?type=link"

# Extract reset token
curl "http://127.0.0.1:1080/messages/1/extract?type=token"`}
                  language="bash"
                />
              </div>

              {/* Extract Links */}
              <div id="get-links" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id/links.json</code>
                </div>
                <p class="text-gray-700 mb-6">Returns all links found in the message with metadata about their purpose (verification, unsubscribe, etc).</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1/links.json`}
                  language="bash"
                />
              </div>

              {/* Parse Structured Data */}
              <div id="parse-data" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id/parsed.json</code>
                </div>
                <p class="text-gray-700 mb-6">Returns comprehensive structured data parsed from the message including verification URLs, OTP codes, reset tokens, and all links.</p>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1/parsed.json`}
                  language="bash"
                />
              </div>

              {/* Accessibility Score */}
              <div id="accessibility" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id/accessibility.json</code>
                </div>
                <p class="text-gray-700 mb-6">Analyzes HTML email for accessibility issues and returns a score (0-100) with recommendations.</p>
                <h4 class="font-display font-semibold text-anthracite mb-3 mt-6">Score Breakdown</h4>
                <ul class="text-sm text-gray-700 space-y-1 mb-6">
                  <li>• <code>images_with_alt</code> - Percentage of images with alt text</li>
                  <li>• <code>semantic_html</code> - Use of semantic HTML tags</li>
                  <li>• <code>score</code> - Overall accessibility score (0-100)</li>
                </ul>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/messages/1/accessibility.json`}
                  language="bash"
                />
              </div>
            </div>
          </div>

          {/* Management Operations */}
          <div>
            <h2 class="font-display text-2xl font-bold text-anthracite mb-8">Management</h2>
            <div class="space-y-8">

              {/* Forward Message */}
              <div id="forward-message" class="scroll-mt-24 border-l-4 border-green-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-green-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">POST</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id/forward</code>
                </div>
                <p class="text-gray-700 mb-6">Forwards the caught email to its original recipient(s) using a configured SMTP server. Useful for final validation after testing.</p>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                  <p class="text-sm text-amber-900"><strong>Note:</strong> Requires MailCatcher to be started with SMTP forwarding configuration.</p>
                </div>
                <CodeBlock
                  code={`# Start MailCatcher with forwarding enabled
mailcatcher \\
  --forward-smtp-host smtp.example.com \\
  --forward-smtp-port 587 \\
  --forward-smtp-user your-username@example.com \\
  --forward-smtp-password your-password

# Then forward a message
curl -X POST http://127.0.0.1:1080/messages/1/forward`}
                  language="bash"
                />
              </div>

              {/* Delete Message */}
              <div id="delete-message" class="scroll-mt-24 border-l-4 border-red-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-red-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">DELETE</span>
                  <code class="font-mono text-lg text-anthracite">/messages/:id</code>
                </div>
                <p class="text-gray-700 mb-6">Deletes a specific message from storage.</p>
                <CodeBlock
                  code={`curl -X DELETE http://127.0.0.1:1080/messages/1`}
                  language="bash"
                />
              </div>

              {/* Delete All Messages */}
              <div id="delete-all" class="scroll-mt-24 border-l-4 border-red-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-red-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">DELETE</span>
                  <code class="font-mono text-lg text-anthracite">/messages</code>
                </div>
                <p class="text-gray-700 mb-6">Clears all stored messages.</p>
                <CodeBlock
                  code={`curl -X DELETE http://127.0.0.1:1080/messages`}
                  language="bash"
                />
              </div>
            </div>
          </div>

          {/* System Operations */}
          <div>
            <h2 class="font-display text-2xl font-bold text-anthracite mb-8">System</h2>
            <div class="space-y-8">

              {/* Server Info */}
              <div id="server-info" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/server-info</code>
                </div>
                <p class="text-gray-700 mb-6">Returns server configuration and status information.</p>
                <h4 class="font-display font-semibold text-anthracite mb-3 mt-6">Response Includes</h4>
                <ul class="text-sm text-gray-700 space-y-1 mb-6">
                  <li>• MailCatcher version</li>
                  <li>• HTTP and SMTP server ports</li>
                  <li>• Hostname and IP addresses</li>
                  <li>• Connection counts and statistics</li>
                </ul>
                <CodeBlock
                  code={`curl http://127.0.0.1:1080/server-info`}
                  language="bash"
                />
              </div>

              {/* WebSocket */}
              <div id="websocket" class="scroll-mt-24 border-l-4 border-forest-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-blue-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">GET</span>
                  <code class="font-mono text-lg text-anthracite">/messages (WebSocket)</code>
                </div>
                <p class="text-gray-700 mb-6">Upgrades the HTTP connection to WebSocket for receiving real-time notifications about new messages, deletions, and clears.</p>
                <h4 class="font-display font-semibold text-anthracite mb-3 mt-6">Message Types</h4>
                <ul class="text-sm text-gray-700 space-y-1 mb-6">
                  <li>• <code class="bg-gray-200 px-2 py-1 rounded">add</code> - New message arrived</li>
                  <li>• <code class="bg-gray-200 px-2 py-1 rounded">remove</code> - Message was deleted</li>
                  <li>• <code class="bg-gray-200 px-2 py-1 rounded">clear</code> - All messages cleared</li>
                </ul>
                <CodeBlock
                  code={`const ws = new WebSocket('ws://127.0.0.1:1080/messages');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === 'add') {
    console.log('New message:', data.message);
  } else if (data.type === 'remove') {
    console.log('Message deleted:', data.id);
  }
};`}
                  language="javascript"
                />
              </div>

              {/* Quit Server */}
              <div id="quit" class="scroll-mt-24 border-l-4 border-red-600 pl-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="inline-block bg-red-600 text-white px-3 py-1 rounded font-mono text-sm font-bold">DELETE</span>
                  <code class="font-mono text-lg text-anthracite">/</code>
                </div>
                <p class="text-gray-700 mb-6">Terminates the MailCatcher server instance.</p>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                  <p class="text-sm text-red-900"><strong>⚠️ Warning:</strong> This will shut down the server. Use the <code class="bg-red-200 px-2 py-1 rounded">--no-quit</code> flag to disable this endpoint.</p>
                </div>
                <CodeBlock
                  code={`curl -X DELETE http://127.0.0.1:1080/`}
                  language="bash"
                />
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </div>
</Layout>
