---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

const title = 'Installation Guide - MailCatcher NG';
const description = 'Complete installation guide for MailCatcher NG. Docker, Ruby Gem, from source, framework integration, SSL/TLS, persistent storage, and troubleshooting.';
---

<BaseLayout title={title} description={description}>
  <Navigation activePage="install" />

  <section class="bg-gradient-to-r from-primary to-primary-dark text-white px-5 py-16 text-center">
    <h1>Installation Guide</h1>
    <p>Get MailCatcher NG running in minutes</p>
  </section>

  <section class="install-content">
    <div class="max-w-6xl mx-auto px-5">
        <div class="grid grid-cols-1 gap-12 max-w-2xl mx-auto">
            <!-- Docker Installation -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Docker (Recommended)</h2>
                <p>The fastest and easiest way to get started. No installation, no dependencies—just pure containerized mail catching.</p>
                <pre><code>docker run -d -p 1080:1080 -p 1025:1025 stpaquet/alpinemailcatcher</code></pre>
                <p>Then:</p>
                <ul>
                    <li>View mail at <code>http://127.0.0.1:1080</code></li>
                    <li>Send mail to <code>smtp://127.0.0.1:1025</code></li>
                </ul>
                <p><a href="https://hub.docker.com/r/stpaquet/alpinemailcatcher" target="_blank">View on Docker Hub →</a></p>
            </div>

            <!-- Ruby Gem Installation -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Ruby Gem Installation</h2>
                <p>MailCatcher NG requires Ruby 3.2 or higher. Check your version:</p>
                <pre><code>ruby -v</code></pre>
                <p>Install via RubyGems:</p>
                <pre><code>gem install mailcatcher-ng</code></pre>
                <p>Start the server:</p>
                <pre><code>mailcatcher</code></pre>
                <p>Then:</p>
                <ul>
                    <li>View mail at <code>http://127.0.0.1:1080</code></li>
                    <li>Send mail to <code>smtp://127.0.0.1:1025</code></li>
                </ul>
            </div>

            <!-- Build from Source -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Build from Source</h2>
                <pre><code>git clone https://github.com/spaquet/mailcatcher.git
cd mailcatcher
bundle install
bundle exec mailcatcher --foreground</code></pre>
            </div>

            <!-- Framework Integration -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Framework Integration</h2>
                <p>Configure your framework to send mail to MailCatcher NG:</p>

                <h3>Rails</h3>
                <p>Add to <code>config/environments/development.rb</code>:</p>
                <pre><code>config.action_mailer.delivery_method = :smtp
config.action_mailer.smtp_settings = &#123;
  address: '127.0.0.1',
  port: 1025
&#125;
config.action_mailer.raise_delivery_errors = false</code></pre>

                <h3>Django</h3>
                <p>Add to <code>settings.py</code>:</p>
                <pre><code>if DEBUG:
    EMAIL_HOST = '127.0.0.1'
    EMAIL_HOST_USER = ''
    EMAIL_HOST_PASSWORD = ''
    EMAIL_PORT = 1025
    EMAIL_USE_TLS = False</code></pre>

                <h3>Laravel</h3>
                <p>Update <code>.env</code>:</p>
                <pre><code>MAIL_MAILER=smtp
MAIL_HOST=127.0.0.1
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null</code></pre>

                <h3>PHP (using sendmail)</h3>
                <p>Update <code>php.ini</code> sendmail path:</p>
                <pre><code>sendmail_path = /usr/bin/env catchmail -f from@example.com</code></pre>

                <h3>Node.js (Nodemailer)</h3>
                <pre><code>const nodemailer = require('nodemailer');
const transporter = nodemailer.createTransport(&#123;
  host: '127.0.0.1',
  port: 1025,
  direct: true
&#125;);</code></pre>

                <h3>Go</h3>
                <pre><code>package main
import "net/smtp"

func main() &#123;
    client, _ := smtp.Dial("127.0.0.1:1025")
    defer client.Close()
&#125;</code></pre>

                <h3>Java</h3>
                <pre><code>Properties props = new Properties();
props.put("mail.smtp.host", "127.0.0.1");
props.put("mail.smtp.port", "1025");
Session session = Session.getInstance(props);</code></pre>
            </div>

            <!-- Command Line Options -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Command Line Options</h2>
                <pre><code>mailcatcher --help

Options:
  --ip IP                    Set IP address for both servers
  --smtp-ip IP              Set SMTP server IP
  --smtp-port PORT          Set SMTP port (default: 1025)
  --http-ip IP              Set HTTP server IP
  --http-port PORT          Set HTTP port (default: 1080)
  --messages-limit COUNT    Keep only N most recent messages
  --persistence             Store messages in persistent SQLite database
  --http-path PATH          Add prefix to all HTTP paths
  --no-quit                 Disable quit functionality
  -f, --foreground          Run in foreground
  -b, --browse              Open web browser on start
  -v, --verbose             Be more verbose
  -h, --help                Show help
  --version                 Show version</code></pre>
            </div>

            <!-- Persistent Storage -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Persistent Storage</h2>
                <p>By default, MailCatcher NG stores messages in memory and they are lost when the process terminates. Enable persistent storage to keep messages across restarts:</p>
                <pre><code>mailcatcher --persistence</code></pre>
                <p>Messages will be stored in <code>~/.mailcatcher/mailcatcher.db</code></p>

                <h3>Docker with Persistent Storage</h3>
                <p>Mount a volume to persist messages across container restarts:</p>
                <pre><code>docker run -d \
  -p 1080:1080 \
  -p 1025:1025 \
  -v mailcatcher_data:/root/.mailcatcher \
  stpaquet/alpinemailcatcher</code></pre>
                <p>Or with a bind mount to a host directory:</p>
                <pre><code>docker run -d \
  -p 1080:1080 \
  -p 1025:1025 \
  -v /path/to/local/storage:/root/.mailcatcher \
  stpaquet/alpinemailcatcher</code></pre>
            </div>

            <!-- SSL/TLS Configuration -->
            <div class="border-l-4 border-primary pl-8">
                <h2>SSL/TLS Encryption</h2>
                <p>MailCatcher NG supports encrypted SMTP connections. You must provide your own certificate and private key files.</p>

                <h3>Generate Self-Signed Certificate (Testing Only)</h3>
                <pre><code>openssl req -x509 -newkey rsa:4096 \
  -keyout mailcatcher-key.pem \
  -out mailcatcher-cert.pem \
  -days 365 -nodes \
  -subj "/CN=localhost"</code></pre>

                <h3>Start with SSL/TLS</h3>
                <pre><code>mailcatcher \
  --smtp-ssl \
  --smtp-ssl-cert mailcatcher-cert.pem \
  --smtp-ssl-key mailcatcher-key.pem</code></pre>

                <p>This enables:</p>
                <ul>
                    <li><strong>STARTTLS on port 1025</strong>: Upgrade to TLS after connecting</li>
                    <li><strong>Direct TLS on port 1465</strong>: Encrypted from the start (SMTPS)</li>
                </ul>

                <h3>Rails with STARTTLS</h3>
                <pre><code>config.action_mailer.smtp_settings = &#123;
  address: '127.0.0.1',
  port: 1025,
  enable_starttls_auto: true
&#125;</code></pre>

                <h3>Rails with Direct TLS (SMTPS)</h3>
                <pre><code>config.action_mailer.smtp_settings = &#123;
  address: '127.0.0.1',
  port: 1465,
  enable_starttls_auto: false,
  ssl: true
&#125;</code></pre>

                <h3>Django with TLS</h3>
                <pre><code>if DEBUG:
    EMAIL_HOST = '127.0.0.1'
    EMAIL_PORT = 1465  # Direct TLS
    EMAIL_USE_TLS = True
    EMAIL_USE_SSL = True</code></pre>

                <h3>PHP with TLS</h3>
                <pre><code>MAIL_PORT=1465
MAIL_ENCRYPTION=ssl</code></pre>

                <h3>Security Notes</h3>
                <ul>
                    <li>Certificate and key files must be readable by the mailcatcher process</li>
                    <li>When SSL is enabled, STARTTLS is required (plain SMTP is disabled)</li>
                    <li>Self-signed certificates will trigger warnings in mail clients</li>
                    <li>For production-like testing, use certificates from your CA or Let's Encrypt</li>
                </ul>
            </div>

            <!-- Troubleshooting -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Troubleshooting</h2>

                <h3>Port Already in Use</h3>
                <p>Use different ports:</p>
                <pre><code>mailcatcher --smtp-port 2025 --http-port 2080</code></pre>

                <h3>Ruby Not Found</h3>
                <p>Ensure Ruby 3.2+ is installed:</p>
                <pre><code>brew install ruby  # macOS
apt install ruby   # Ubuntu/Debian</code></pre>

                <h3>Build Tools Missing</h3>
                <p>Install build tools for gem compilation:</p>
                <pre><code>apt install build-essential  # Ubuntu/Debian
xcode-select --install      # macOS</code></pre>

                <h3>RVM Users</h3>
                <p>MailCatcher may only be available in the Ruby version it was installed in:</p>
                <pre><code>rvm default@mailcatcher --create do gem install mailcatcher-ng
rvm alias create mailcatcher default@mailcatcher</code></pre>

                <h3>Docker Issues</h3>
                <p>Ensure Docker is running and you have permission to use it:</p>
                <pre><code>docker run hello-world</code></pre>
                <p>If you get a permission error, add your user to the docker group:</p>
                <pre><code>sudo usermod -aG docker $USER</code></pre>
            </div>

            <!-- Claude Integration -->
            <div class="border-l-4 border-primary pl-8">
                <h2>Claude Integration</h2>
                <p>MailCatcher NG integrates with Claude for AI-powered email testing.</p>

                <h3>Enable Claude Plugin</h3>
                <pre><code>mailcatcher --plugin --foreground</code></pre>
                <p>Then add the plugin in Claude settings at <code>http://localhost:1080/.well-known/ai-plugin.json</code></p>

                <h3>Enable MCP Server</h3>
                <pre><code>mailcatcher --mcp --foreground</code></pre>
                <p>Configure in Claude Desktop's <code>~/.claude_desktop_config.json</code>:</p>
                <pre><code>&#123;
  "mcpServers": &#123;
    "mailcatcher": &#123;
      "command": "mailcatcher",
      "args": ["--mcp", "--foreground"]
    &#125;
  &#125;
&#125;</code></pre>

                <p><a href="claude.html">Learn more about Claude integration →</a></p>
            </div>
        </div>
    </div>
</section>

  <Footer />
</BaseLayout>

<style>
  .page-header {
    background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
    color: white;
    padding: 4rem 1.25rem;
    text-align: center;
  }

  .page-header h1 {
    color: white;
    margin-bottom: 0.5rem;
  }

  .page-header p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.25rem;
  }

  .install-content {
    padding: 4rem 1.25rem;
  }
</style>
